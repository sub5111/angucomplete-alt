/*! Copyright (c) 2014 Hidenari Nozaki and contributors | Licensed under the MIT license */
!function(a,b){"use strict";"undefined"!=typeof module&&module.exports?module.exports=b(require("angular")):"function"==typeof define&&define.amd?define(["angular"],b):b(a.angular)}(window,function(a){"use strict";a.module("angucomplete-alt",[]).directive("angucompleteAlt",["$q","$parse","$http","$sce","$timeout","$templateCache","$interpolate","$location",function(b,c,d,e,f,g,h,i){function j(c,g,h,i){function j(a,b){a&&("object"==typeof a?(c.searchStr=D(a),A({originalObject:a})):"string"==typeof a&&a.length>0?c.searchStr=a:console&&console.error&&console.error("Tried to set "+(b?"initial":"")+" value of angucomplete to",a,"which is an invalid value"),G(!0))}function y(a){na=null,c.hideResults(a),document.body.removeEventListener("click",y)}function z(a){return a.which?a.which:a.keyCode}function A(a){"function"==typeof c.selectedObject?c.selectedObject(a,c.selectedObjectData):c.selectedObject=a,G(a?!0:!1)}function B(a){return function(b){return c[a]?c[a](b):b}}function C(a){A({originalObject:a}),c.clearSelected&&(c.searchStr=null),V()}function D(a){return c.titleField.split(",").map(function(b){return E(a,b)}).join(" ")}function E(a,b){var c,d;if(b){c=b.split("."),d=a;for(var e=0;e<c.length;e++)d=d[c[e]]}else d=a;return d}function F(a,b){var d,f,g;if(g=new RegExp(b.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),"i"),a)return a.match&&a.replace||(a=a.toString()),f=a.match(g),d=f?a.replace(g,'<span class="'+c.matchClass+'">'+f[0]+"</span>"):a,e.trustAsHtml(d)}function G(a){c.notEmpty=a,ja=c.searchStr,c.fieldRequired&&i&&c.inputName&&i[c.inputName].$setValidity(ia,a)}function H(a){var b=z(a);if(b!==n&&b!==l)if(b===m||b===p)a.preventDefault();else if(b===k)a.preventDefault(),!c.showDropdown&&c.searchStr&&c.searchStr.length>=ga&&(W(),c.searching=!0,Z(c.searchStr));else if(b===o)V(),c.$apply(function(){fa.val(c.searchStr)});else{if(0===ga&&!c.searchStr)return;c.searchStr&&""!==c.searchStr?c.searchStr.length>=ga&&(W(),ha&&f.cancel(ha),c.searching=!0,ha=f(function(){Z(c.searchStr)},c.pause)):c.showDropdown=!1,ja&&ja!==c.searchStr&&!c.clearSelected&&c.$apply(function(){A()})}}function I(a){!c.overrideSuggestions||c.selectedObject&&c.selectedObject.originalObject===c.searchStr||(a&&a.preventDefault(),f.cancel(ha),S(),C(c.searchStr))}function J(a){var b=getComputedStyle(a);return a.offsetHeight+parseInt(b.marginTop,10)+parseInt(b.marginBottom,10)}function K(){return la.getBoundingClientRect().top+parseInt(getComputedStyle(la).maxHeight,10)}function L(){return g[0].querySelectorAll(".angucomplete-row")[c.currentIndex]}function M(){return L().getBoundingClientRect().top-(la.getBoundingClientRect().top+parseInt(getComputedStyle(la).paddingTop,10))}function N(a){la.scrollTop=la.scrollTop+a}function O(){var a=c.results[c.currentIndex];c.matchClass?fa.val(D(a.originalObject)):fa.val(a.title)}function P(b){var d=z(b),e=null,f=null;d===p&&c.results?(c.onEnterPressed?c.onEnterPressed(c.searchStr):a.noop(),c.currentIndex>=0&&c.currentIndex<c.results.length?(b.preventDefault(),c.selectResult(c.results[c.currentIndex])):(I(b),V()),c.$apply()):d===k&&c.results?(b.preventDefault(),c.currentIndex+1<c.results.length&&c.showDropdown&&(c.$apply(function(){c.currentIndex++,O()}),ma&&(e=L(),K()<e.getBoundingClientRect().bottom&&N(J(e))))):d===m&&c.results?(b.preventDefault(),c.currentIndex>=1?(c.$apply(function(){c.currentIndex--,O()}),ma&&(f=M())<0&&N(f-1)):0===c.currentIndex&&c.$apply(function(){c.currentIndex=-1,fa.val(c.searchStr)})):d===q?c.results&&c.results.length>0&&c.showDropdown?-1===c.currentIndex&&c.overrideSuggestions?I():(-1===c.currentIndex&&(c.currentIndex=0),c.selectResult(c.results[c.currentIndex]),c.$digest()):c.searchStr&&c.searchStr.length>0&&I():d===o&&b.preventDefault()}function Q(a){return function(b,d,e,f){d||e||f||!b.data||(b=b.data),c.searching=!1,$(E(ba(b),c.remoteUrlDataField),a)}}function R(a,b,d,e){c.searching=!1,0!==b&&-1!==b&&(b||d||e||(b=a.status),c.remoteUrlErrorCallback?c.remoteUrlErrorCallback(a,b,d,e):console&&console.error&&console.error("http error"))}function S(){ka&&ka.resolve()}function T(a){var e={},f=c.remoteUrl+encodeURIComponent(a);c.remoteUrlRequestFormatter&&(e={params:c.remoteUrlRequestFormatter(a)},f=c.remoteUrl),c.remoteUrlRequestWithCredentials&&(e.withCredentials=!0),S(),ka=b.defer(),e.timeout=ka.promise,d.get(f,e).success(Q(a)).error(R)}function U(a){S(),ka=b.defer(),c.remoteApiHandler(a,ka.promise).then(Q(a)).catch(R)}function V(){c.showDropdown=!1,c.results=[],la&&(la.scrollTop=0)}function W(){c.showDropdown=da,c.currentIndex=c.focusFirst?0:-1,c.results=[]}function X(a){var b,d,e,f,g=c.searchFields.split(","),h=[];for(void 0!==c.parseInput()&&(a=c.parseInput()(a)),b=0;b<c.localData.length;b++){for(d=!1,e=0;e<g.length;e++)f=E(c.localData[b],g[e])||"",d=d||f.toString().toLowerCase().indexOf(a.toString().toLowerCase())>=0;d&&(h[h.length]=c.localData[b])}return h}function Y(a,b,d){if(!d)return!1;for(var e in b)if(b[e].toLowerCase()===d.toLowerCase())return c.selectResult(a),!0;return!1}function Z(a){!a||a.length<ga||(c.localData?c.$apply(function(){var b;b=void 0!==c.localSearch()?c.localSearch()(a,c.localData):X(a),c.searching=!1,$(b,a)}):c.remoteApiHandler?U(a):T(a))}function $(a,b){var d,e,f,g,h,i;if(a&&a.length>0)for(c.results=[],d=0;d<a.length;d++)c.titleField&&""!==c.titleField&&(g=h=D(a[d])),e="",c.descriptionField&&(e=i=E(a[d],c.descriptionField)),f="",c.imageField&&(f=E(a[d],c.imageField)),c.matchClass&&(h=F(g,b),i=F(e,b)),c.results[c.results.length]={title:h,description:i,image:f,originalObject:a[d]};else c.results=[];c.autoMatch&&1===c.results.length&&Y(c.results[0],{title:g,desc:e||""},c.searchStr)?c.showDropdown=!1:0!==c.results.length||ea?c.showDropdown=!0:c.showDropdown=!1}function _(){c.localData?$(c.localData,""):c.remoteApiHandler?U(""):T("")}var aa,ba,ca,da,ea,fa=g.find("input"),ga=r,ha=null,ia=v,ja=null,ka=null,la=g[0].querySelector(".angucomplete-dropdown"),ma=!1,na=null;g.on("mousedown",function(a){a.target.id?(na=a.target.id)===c.id+"_dropdown"&&document.body.addEventListener("click",y):na=a.target.className}),c.currentIndex=c.focusFirst?0:null,c.searching=!1,ca=c.$watch("initialValue",function(a){a&&(ca(),j(a,!0))}),c.$watch("fieldRequired",function(a,b){a!==b&&(a?G(ja&&-1!==c.currentIndex?!0:!1):i[c.inputName].$setValidity(ia,!0))}),c.$on("angucomplete-alt:clearInput",function(a,b){b&&b!==c.id||(c.searchStr=null,A(),G(!1),V())}),c.$on("angucomplete-alt:changeInput",function(a,b,d){b&&b===c.id&&j(d)}),c.onFocusHandler=function(){c.focusIn&&c.focusIn(),0!==ga||c.searchStr&&0!==c.searchStr.length||(c.currentIndex=c.focusFirst?0:c.currentIndex,c.showDropdown=!0,_())},c.hideResults=function(){na&&(na===c.id+"_dropdown"||na.indexOf("angucomplete")>=0)?na=null:(aa=f(function(){V(),c.$apply(function(){c.searchStr&&c.searchStr.length>0&&fa.val(c.searchStr)})},u),S(),c.focusOut&&c.focusOut(),c.overrideSuggestions&&c.searchStr&&c.searchStr.length>0&&-1===c.currentIndex&&I())},c.resetHideResults=function(){aa&&f.cancel(aa)},c.hoverRow=function(a){c.currentIndex=a},c.selectResult=function(a){c.matchClass&&(a.title=D(a.originalObject),a.description=E(a.originalObject,c.descriptionField)),c.clearSelected?c.searchStr=null:c.searchStr=a.title,A(a),V()},c.inputChangeHandler=function(a){return a.length<ga?(S(),V()):0===a.length&&0===ga&&(c.searching=!1,_()),c.inputChanged&&(a=c.inputChanged(a)),a},c.fieldRequiredClass&&""!==c.fieldRequiredClass&&(ia=c.fieldRequiredClass),c.minlength&&""!==c.minlength&&(ga=parseInt(c.minlength,10)),c.pause||(c.pause=t),c.clearSelected||(c.clearSelected=!1),c.overrideSuggestions||(c.overrideSuggestions=!1),c.fieldRequired&&i&&G(c.initialValue?!0:!1),c.inputType=h.type?h.type:"text",c.textSearching=h.textSearching?h.textSearching:w,c.textNoResults=h.textNoResults?h.textNoResults:x,da="false"!==c.textSearching,ea="false"!==c.textNoResults,c.maxlength=h.maxlength?h.maxlength:s,fa.on("keydown",P),fa.on("keyup",H),ba=B("remoteUrlResponseFormatter"),f(function(){var a=getComputedStyle(la);ma=a.maxHeight&&"auto"===a.overflowY})}var k=40,l=39,m=38,n=37,o=27,p=13,q=9,r=3,s=524288,t=500,u=200,v="autocomplete-required",w="Searching...",x="No results found",y="/angucomplete-alt/index.html";return g.put(y,'<div class="angucomplete-holder" ng-class="{\'angucomplete-dropdown-visible\': showDropdown}">  <input id="{{id}}_value" name="{{inputName}}" tabindex="{{fieldTabindex}}" ng-class="{\'angucomplete-input-not-empty\': notEmpty}" ng-model="searchStr" ng-disabled="disableInput" type="{{inputType}}" placeholder="{{placeholder}}" maxlength="{{maxlength}}" ng-focus="onFocusHandler()" class="{{inputClass}}" ng-focus="resetHideResults()" ng-blur="hideResults($event)" autocapitalize="off" autocorrect="off" autocomplete="off" ng-change="inputChangeHandler(searchStr)"/>  <div id="{{id}}_dropdown" class="angucomplete-dropdown" ng-show="showDropdown">    <div class="angucomplete-searching" ng-show="searching" ng-bind="textSearching"></div>    <div class="angucomplete-searching" ng-show="!searching && (!results || results.length == 0)" ng-bind="textNoResults"></div>    <div class="angucomplete-row" ng-repeat="result in results" ng-click="selectResult(result)" ng-mouseenter="hoverRow($index)" ng-class="{\'angucomplete-selected-row\': $index == currentIndex}">      <div ng-if="imageField" class="angucomplete-image-holder">        <img ng-if="result.image && result.image != \'\'" ng-src="{{result.image}}" class="angucomplete-image"/>        <div ng-if="!result.image && result.image != \'\'" class="angucomplete-image-default"></div>      </div>      <div class="angucomplete-title" ng-if="matchClass" ng-bind-html="result.title"></div>      <div class="angucomplete-title" ng-if="!matchClass">{{ result.title }}</div>      <div ng-if="matchClass && result.description && result.description != \'\'" class="angucomplete-description" ng-bind-html="result.description"></div>      <div ng-if="!matchClass && result.description && result.description != \'\'" class="angucomplete-description">{{result.description}}</div>    </div>  </div></div>'),{restrict:"EA",require:"^?form",scope:{selectedObject:"=",onEnterPressed:"=",selectedObjectData:"=",disableInput:"=",initialValue:"=",localData:"=",localSearch:"&",remoteUrlRequestFormatter:"=",remoteUrlRequestWithCredentials:"@",remoteUrlResponseFormatter:"=",remoteUrlErrorCallback:"=",remoteApiHandler:"=",id:"@",type:"@",placeholder:"@",textSearching:"@",textNoResults:"@",remoteUrl:"@",remoteUrlDataField:"@",titleField:"@",descriptionField:"@",imageField:"@",inputClass:"@",pause:"@",searchFields:"@",minlength:"@",matchClass:"@",clearSelected:"@",overrideSuggestions:"@",fieldRequired:"=",fieldRequiredClass:"@",inputChanged:"=",autoMatch:"@",focusOut:"&",focusIn:"&",searchStr:"=ngModel",fieldTabindex:"@",inputName:"@",focusFirst:"@",parseInput:"&"},templateUrl:function(a,b){return b.templateUrl||y},compile:function(a){var b=h.startSymbol(),c=h.endSymbol();if("{{"!==b||"}}"!==c){var d=a.html().replace(/\{\{/g,b).replace(/\}\}/g,c);a.html(d)}return j}}}])});